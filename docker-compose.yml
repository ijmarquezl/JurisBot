# Docker Compose for Multi-Tenant Architecture
# This setup reflects a professional, scalable, and secure architecture.
version: '3.8'

services:
  # --- REVERSE PROXY (Public Entrypoint) ---
  proxy:
    build: ./proxy
    ports:
      - "80:80"
    depends_on:
      - frontend
      - backend
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.10

  # --- SHARED SERVICES (for all tenants) ---

  frontend:
    build:
      context: ./jurisconsultor/frontend
      dockerfile: Dockerfile
    environment:
      VITE_API_URL: http://marcalnet.ddns.net # Set VITE_API_URL for the frontend
    # PORTS REMOVED - Accessed via reverse proxy
    depends_on:
      - backend
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.11

  backend:
    build:
      context: ./jurisconsultor
      dockerfile: Dockerfile
    # PORTS REMOVED - Accessed via reverse proxy
    depends_on:
      - postgres_public
      - postgres_a # Depends on tenant DBs for health/startup order
      - mongodb_a
    env_file:
      - .env
    environment:
      # --- Database URIs ---
      # The backend app will need logic to select the correct tenant DB based on the user.
      PUBLIC_POSTGRES_URI: postgresql://${PUBLIC_POSTGRES_USER}:${PUBLIC_POSTGRES_PASSWORD}@postgres_public:5432/${PUBLIC_POSTGRES_DB}
      TENANT_A_POSTGRES_URI: postgresql://${TENANT_A_POSTGRES_USER}:${TENANT_A_POSTGRES_PASSWORD}@postgres_a:5432/${TENANT_A_POSTGRES_DB}
      MONGO_URI: mongodb://${TENANT_MI_PRIMERA_EMPRESA_MONGO_USER}:${TENANT_MI_PRIMERA_EMPRESA_MONGO_PASSWORD}@mongodb_mi_primera_empresa:27017/${TENANT_MI_PRIMERA_EMPRESA_MONGO_DB}?authSource=admin
      MONGO_DB_NAME: ${TENANT_MI_PRIMERA_EMPRESA_MONGO_DB}

      # --- App & Security Config ---
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      GROQ_API_KEY: ${GROQ_API_KEY}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME}
      BACKEND_API_URL: ${BACKEND_API_URL}

      # --- External Services ---
      LLM_URL: ${LLM_URL}
      EMBEDDING_MODEL_NAME: ${EMBEDDING_MODEL_NAME}
    command: [ "/bin/bash", "-c", "sleep 15 && uvicorn main:app --host 0.0.0.0 --port 8000" ]
    volumes:
      - ./jurisconsultor/documentos_legales:/docs
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.12

  scheduler:
    build:
      context: ./jurisconsultor
      dockerfile: Dockerfile
    depends_on:
      - backend
      - mongodb_mi_primera_empresa # Ensure MongoDB is up before scheduler tries to connect
    env_file:
      - .env
    environment:
      # The scheduler needs the same environment variables as the backend
      # to connect to databases and other services.
      PUBLIC_POSTGRES_URI: postgresql://${PUBLIC_POSTGRES_USER}:${PUBLIC_POSTGRES_PASSWORD}@postgres_public:5432/${PUBLIC_POSTGRES_DB}
      TENANT_A_POSTGRES_URI: postgresql://${TENANT_A_POSTGRES_USER}:${TENANT_A_POSTGRES_PASSWORD}@postgres_a:5432/${TENANT_A_POSTGRES_DB}
      MONGO_URI: mongodb://${TENANT_MI_PRIMERA_EMPRESA_MONGO_USER}:${TENANT_MI_PRIMERA_EMPRESA_MONGO_PASSWORD}@mongodb_mi_primera_empresa:27017/${TENANT_MI_PRIMERA_EMPRESA_MONGO_DB}?authSource=admin
      MONGO_DB_NAME: ${TENANT_MI_PRIMERA_EMPRESA_MONGO_DB}
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      GROQ_API_KEY: ${GROQ_API_KEY}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME}
      BACKEND_API_URL: ${BACKEND_API_URL}
      LLM_URL: ${LLM_URL}
      EMBEDDING_MODEL_NAME: ${EMBEDDING_MODEL_NAME}
    command: ["python", "-u", "scheduler.py"]
    networks:
      jurisconsultor-net:

  jurisbot-project-manager-mcp:
    build:
      context: ./project_manager_mcp
      dockerfile: Dockerfile
    container_name: jurisbot-project-manager-mcp
    env_file:
      - .env # Asegúrate de que tenga las variables de conexión a la BD privada del tenant
    ports:
      - "8001:8000" # Puerto para el tráfico del servidor MCP
    depends_on:
      - postgres_public # MCP server needs to connect to public DB for tenant lookup
      - postgres_a # Example dependency for tenant A's DB
      - mongodb_a # Example dependency for tenant A's DB
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.13

  postgres_public:
    image: pgvector/pgvector:pg13
    environment:
      POSTGRES_USER: ${PUBLIC_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PUBLIC_POSTGRES_PASSWORD}
      POSTGRES_DB: ${PUBLIC_POSTGRES_DB}
    volumes:
      - postgres_public_data:/var/lib/postgresql/data
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.14

  # --- EXAMPLE TENANT 'A' SERVICES ---
  # In a real production environment, these would be provisioned for each company.

  postgres_a:
    image: postgres:13-alpine
    environment:
      POSTGRES_USER: ${TENANT_A_POSTGRES_USER}
      POSTGRES_PASSWORD: ${TENANT_A_POSTGRES_PASSWORD}
      POSTGRES_DB: ${TENANT_A_POSTGRES_DB}
    volumes:
      - postgres_tenant_a_data:/var/lib/postgresql/data
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.15

  mongodb_a:
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${TENANT_A_MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${TENANT_A_MONGO_PASSWORD}
    volumes:
      - mongodb_tenant_a_data:/data/db
    networks:
      jurisconsultor-net:
        ipv4_address: 172.25.0.16

volumes:
  postgres_public_data:
  postgres_tenant_a_data:
  mongodb_tenant_a_data:


networks:
  jurisconsultor-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
